
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title></title>
	<meta name="author" content="ishkawa">

	
	<meta name="description" content="すべてのテストケースの前後にあれこれする iOSのアプリケーションテストを書いていると、各テストケースの前後に永続ストアやスタブサーバーなどをリセットしたくなることがあると思います。
リセットが必要なテストスイートのsetUp/tearDownに書いても良いのですが、 &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="blog.ishkawa.org" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script async="true" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">blog.ishkawa.org</a></h1>
<nav id="main-nav"><ul class="main">
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="https://twitter.com/_ishkawa">Twitter</a></li>
  <li><a href="https://github.com/ishkawa">GitHub</a></li>
</ul>

</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul class="main">
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="https://twitter.com/_ishkawa">Twitter</a></li>
  <li><a href="https://github.com/ishkawa">GitHub</a></li>
</ul>

</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:blog.ishkawa.org">
			</form>
		</div>
	</div>
</nav>

</header>
	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/04/30/pre-post-test-case/">
		
			すべてのテストケースの前後にあれこれする</a>
	</h2>
	<div class="entry-content">
		<p>iOSのアプリケーションテストを書いていると、各テストケースの前後に永続ストアやスタブサーバーなどをリセットしたくなることがあると思います。
リセットが必要なテストスイートのsetUp/tearDownに書いても良いのですが、書くのが面倒だったり書き忘れてしまうこともあるので、
すべてのテストケースについてリセットが走るようにしておいた方が心を穏やかにすることができると思います。</p>

<h3>実現方法</h3>

<p>すぐに思いついたのは以下のような方法です。</p>

<ul>
<li>setUp/tearDownにリセット処理を加えたサブクラスを継承させる</li>
<li>XCTestCaseのsetUp/tearDownをswizzleする</li>
</ul>


<p>サブクラスを継承させる方法には、KIFTestCaseなど他のライブラリのクラスには適用ができないという問題があります。
method swizzlingを利用する方法は、他のmethod swizzlingと衝突する可能性があるのでなるべく避けたいものです。</p>

<p>そこで、着目したのがXCTestObserverです。
XCTestObserverは以下のようなイベントが発生したときに対応したメソッドを実行します。</p>

<ul>
<li>テストの開始/終了</li>
<li>テストスイートの開始/終了</li>
<li>テストケースの開始/終了</li>
</ul>


<p>これらのイベントを受け取るには予めNSUserDefaultsのXCTestObserverClassKeyというキーにクラス名を設定しておく必要があります。
具体的には、以下のようなクラスを作成します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="k">@implementation</span> <span class="nc">ISTestObserver</span>
</span><span class='line'>
</span><span class='line'><span class="k">+</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">load</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="err">@</span><span class="n">autoreleasepool</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSUserDefaults</span> <span class="o">*</span><span class="n">defaults</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSUserDefaults</span> <span class="n">standardUserDefaults</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">defaults</span> <span class="nl">setObject:</span><span class="s">@&quot;XCTestLog,ISTestObserver&quot;</span> <span class="nl">forKey:</span><span class="n">XCTestObserverClassKey</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">defaults</span> <span class="n">synchronize</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">testCaseDidStart:</span><span class="p">(</span><span class="n">XCTestRun</span> <span class="o">*</span><span class="p">)</span><span class="nv">testRun</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// reset</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">testCaseDidStop:</span><span class="p">(</span><span class="n">XCTestRun</span> <span class="o">*</span><span class="p">)</span><span class="nv">testRun</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// reset</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>リセット処理の例</h3>

<p>自分が利用している例を紹介します。</p>

<h4>NSUserDefaultsのリセット</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">removeStandardUserDefaultsPersistentDomain</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">NSString</span> <span class="o">*</span><span class="n">bundleIndetifier</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSBundle</span> <span class="n">mainBundle</span><span class="p">].</span><span class="n">bundleIdentifier</span><span class="p">;</span>
</span><span class='line'>    <span class="n">NSUserDefaults</span> <span class="o">*</span><span class="n">userDefaults</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSUserDefaults</span> <span class="n">standardUserDefaults</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">userDefaults</span> <span class="nl">removePersistentDomainForName:</span><span class="n">bundleIndetifier</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>NSHTTPCookieStorageのリセット</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">removeAllCookies</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">NSHTTPCookieStorage</span> <span class="o">*</span><span class="n">cookieStrage</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSHTTPCookieStorage</span> <span class="n">sharedHTTPCookieStorage</span><span class="p">];</span>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="kt">id</span> <span class="n">cookie</span> <span class="k">in</span> <span class="p">[</span><span class="n">cookieStrage</span> <span class="n">cookies</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>      <span class="p">[</span><span class="n">cookieStrage</span> <span class="nl">deleteCookie:</span><span class="n">cookie</span><span class="p">];</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>OHHTTPStubsのリセットと汎用スタブ</h4>

<p>汎用スタブはテスト実行中に誤って外のURLを読みに行かないようにするためにtestCaseDidStart:で用意しています。
testCaseDidStart:はsetUpよりも先に実行されるので、setUpで他のスタブを追加した場合にはそちらが優先されます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">stubGeneralRequest</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">OHHTTPStubs</span> <span class="nl">stubRequestsPassingTest:</span><span class="o">^</span><span class="kt">BOOL</span><span class="p">(</span><span class="n">NSURLRequest</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">YES</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span> <span class="nl">withStubResponse:</span><span class="o">^</span><span class="n">OHHTTPStubsResponse</span> <span class="o">*</span><span class="p">(</span><span class="n">NSURLRequest</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">NSData</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="s">@&quot;Dummy&quot;</span> <span class="nl">dataUsingEncoding:</span><span class="n">NSUTF8StringEncoding</span><span class="p">];</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">[</span><span class="n">OHHTTPStubsResponse</span> <span class="nl">responseWithData:</span><span class="n">data</span>
</span><span class='line'>                                          <span class="nl">statusCode:</span><span class="mi">200</span>
</span><span class='line'>                                             <span class="nl">headers:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">removeAllStubs</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">OHHTTPStubs</span> <span class="n">removeAllStubs</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>OHHTTPStubsの優先順位についてはREADMEに次のように書かれています。</p>

<blockquote><p>When a network request is performed by the system, the stubs are called in the reverse order that they have been added, the last added stub having priority over the first added ones. The first stub that returns YES for the first parameter of stubRequestsPassingTest:withStubResponse: is then used to reply to the request.</p></blockquote>

<h4>CoreDataの永続ストアの削除</h4>

<p><a href="https://github.com/ishkawa/ISPersistentStack">ISPersistentStack</a>を利用しています。
deleteCurrentStoreの実装については<a href="https://github.com/ishkawa/ISPersistentStack/blob/master/ISPersistentStack/ISPersistentStack.m">ソース</a>を参照してください。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objectivec'><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">dropDatabase</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">[[</span><span class="n">ISPersistentStack</span> <span class="n">sharedStack</span><span class="p">]</span> <span class="n">deleteCurrentStore</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-04-30T13:25:00+09:00" pubdate data-updated="true">Apr 30<span>th</span>, 2014</time></div>
	
</div>

    <br/>
    <a href="//twitter.com/share" class="twitter-share-button" data-url="http://blog.ishkawa.org/blog/2014/04/30/pre-post-test-case/" data-text="すべてのテストケースの前後にあれこれする" data-via="_ishkawa" data-counturl="http://blog.ishkawa.org/blog/2014/04/30/pre-post-test-case/" >Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    </article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/04/28/geo-ir/">
		
			位置情報でリモコンを操作するiOSアプリをリリースしました</a>
	</h2>
	<div class="entry-content">
		<p><img src="/images/2014-04-28/icon.png"></p>

<p><a href="https://itunes.apple.com/jp/app/geo-ir/id856152824">Geo IR</a></p>

<p>Geo IRという名前でリリースしました。例えば、以下のような用途に利用できます。</p>

<ul>
<li>最寄り駅についたらでエアコンをつける</li>
<li>自宅に近づいたら照明を点灯させる</li>
<li>自宅から離れたら様々な電子機器の電源を落とす</li>
</ul>


<p>特に1つ目の用途は便利で、冬には家に着く頃には部屋が暖まった状態にすることができますし、夏には冷えた状態にすることが出来ます。</p>

<h3>利用できる位置情報</h3>

<p><img src="/images/2014-04-28/trigger.png"></p>

<p>アプリを反応させるイベントには以下の2つを指定できます。</p>

<ul>
<li>ターゲットエリア: 指定地点から半径nメートル</li>
<li>トリガー: ターゲットエリアへの進入時または退出時</li>
</ul>


<p>これらの情報を組み合わせて、&#8221;最寄り駅に付いた&#8221;や&#8221;自宅から離れた&#8221;といったイベントを定義します。</p>

<h3>利用できるリモコン信号</h3>

<p>基本的にはどのようなリモコンも利用することができます。</p>

<h3>その他必要なもの</h3>

<p>Geo IRの利用にはIRKitが必要です。IRKitはAmazonで購入することができます。</p>

<p><a href="http://www.amazon.co.jp/dp/B00H91KK26">Amazon.co.jp: IRKit &ndash; iPhone,iPadを使って外出先からエアコン等の家電を操作できる学習リモコン</a></p>

<h3>使い方</h3>

<h4>1. IRKitのセットアップ</h4>

<p>起動後に表示される指示に従ってください。<br/>
セットアップが上手くいかない場合は、アプリの再起動とIRKitのリセットをして上で再度試してみてください。</p>

<h4>2. リモコン信号のセットアップ</h4>

<p>設定画面からリモコン信号画面に移り、+ボタンを押してください。<br/>
以下のような画面が表示されたら、IRKitに向けてリモコン信号を送ってください。</p>

<p><img src="/images/2014-04-28/signal.png"></p>

<h4>3. 位置情報のセットアップ</h4>

<p>ターゲットエリアとトリガーを指定してください。</p>

<p><img src="/images/2014-04-28/region.png"></p>

<h4>4. 移動する</h4>

<p>指定したエリアに移動してみてください。リモコン信号の送信が成功すると(失敗すると)アプリに通知が届きます。</p>

<p><img src="/images/2014-04-28/notification.png"></p>

<h4>5. 動作を確認する</h4>

<p>履歴画面から確認できます。送信に失敗してしまった場合には、再送信することも出来ます。</p>

<p><img src="/images/2014-04-28/history.png"></p>

<h3>その他</h3>

<p>Geo IRには広告を非表示にするオプションが有るのですが、In App Purchaseのproduct登録をうっかり忘れてしまったので1.0.0では利用できません。
このオプションの利用を希望する方は、1.0.1がリリースされるまでお待ちください。</p>

<p>アプリのダウンロードは以下のリンクからどうぞ。</p>

<p><a href="https://itunes.apple.com/jp/app/geo-ir/id856152824">Geo IR</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-04-28T21:27:00+09:00" pubdate data-updated="true">Apr 28<span>th</span>, 2014</time></div>
	
</div>

    <br/>
    <a href="//twitter.com/share" class="twitter-share-button" data-url="http://blog.ishkawa.org/blog/2014/04/28/geo-ir/" data-text="位置情報でリモコンを操作するiOSアプリをリリースしました" data-via="_ishkawa" data-counturl="http://blog.ishkawa.org/blog/2014/04/28/geo-ir/" >Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    </article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/04/20/ios-git-tag/">
		
			iOS開発とGitタグ</a>
	</h2>
	<div class="entry-content">
		<p>いままでAppleにアプリを申請するタイミングでタグを打っていて、
その後にリジェクトされると以下のようなタグが残ることがありました。
非常にダサいですね。</p>

<ul>
<li>1.0.0</li>
<li>1.0.0-2</li>
<li>1.0.0-3</li>
</ul>


<p>最近は少し学習して、QAに入る段階でrelease/1.0.0といったブランチを切るようにしました。
審査に出した段階ではまだタグは打たず、もしもリジェクトされた場合は引き続きrelease/1.0.0を更新します。
審査を通過した場合はそこでタグを打って、release/1.0.0をmasterにマージします。
以下の図のようなイメージです。</p>

<p><img src="/images/2014-04-20/git-tag.png"></p>

<p>このように運用することで、余計なタグが打たれることはありませんし、審査中のバージョンを見失うこともありません。
もしかしたら普通のiOSデベロッパーは当たり前のように実践していることなのかもしれませんが、
自分は最近までダサいタグを打ったり、タグを打ち直したりしてたので書きました。</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-04-20T14:18:00+09:00" pubdate data-updated="true">Apr 20<span>th</span>, 2014</time></div>
	
</div>

    <br/>
    <a href="//twitter.com/share" class="twitter-share-button" data-url="http://blog.ishkawa.org/blog/2014/04/20/ios-git-tag/" data-text="iOS開発とGitタグ" data-via="_ishkawa" data-counturl="http://blog.ishkawa.org/blog/2014/04/20/ios-git-tag/" >Tweet</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    </article>

<nav id="pagenavi">
    
        <a href="/" class="prev">Prev</a>
    
    
        <a href="/blog/page/3/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav>
</div>
	<footer id="footer" class="inner">Copyright &copy; 2014

    ishkawa

</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->




	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-35917440-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



</body>
</html>
