---
layout: post
title: "Value binding patternを活用して可変な構造を持つレスポンスを型安全に扱う方法"
date: 2015-11-05 22:04
---

GitHubのEvents APIでは、イベントの種類に応じて一部のJSONの構造が変わります。構造が可変となっているのは`payload`と呼ばれる箇所で、種類に固有の情報は`payload`以下に格納されます。例えば、`CommitCommentEvent`の`payload`は`comment`, `sender`といった情報を持ち、`CreateEvent`や`DeleteEvent`は`ref`, `ref_type`といった情報を持ちます。

[https://developer.github.com/v3/activity/events/types/](https://developer.github.com/v3/activity/events/types/)

SwiftでEvents APIのレスポンスを表そうと考えた場合、以下の2つが思い浮びました。

- `Event`という1つの型を定義して`payload`は`[String: AnyObject]`にする。
- `EventType`というプロトコルを定義して種類ごとに型を定義する。

どちらも微妙な気がしたので、もう少し考えて以下のような方法を試してみました。

```swift
struct Event {
    let id: Int64
    let type: Type

    init(dictionary: [String: AnyObject]) throws {
        ...
    }

    enum Type {
        case CommitCommentEvent(CommitCommentPayload)
        case CreateEvent(ReferencePayload)
        case DeleteEvent(ReferencePayload)
        ...

        init(type: String, payload: [String: AnyObject]) throws {
            switch type {
            case "CommitCommentEvent":
                self = .CommitCommentEvent(try CommitCommentPayload(dictionary: payload))

            case "CreateEvent":
                self = .CreateEvent(try ReferencePayload(dictionary: payload))

            case "DeleteEvent":
                self = .DeleteEvent(try ReferencePayload(dictionary: payload))

            ...
            }
        }

        struct CommitCommentPayload {
            let comment: Comment
            let sender: User

            init(dictionary: [String: AnyObject]) throws {
                ...
            }
        }

        struct ReferencePayload {
            let referenceName: String
            let referenceType: ReferenceType

            init(dictionary: [String: AnyObject]) throws {
                ...
            }
        }
    }
}
```

このように定義すると、`Event`の`type`に応じて可変な`payload`がassociated valueとして取得できるようになり、`Event`の利用側では危険な操作を伴わずに種類に応じたデータを取得できるようになります。

```swift
let event: Event = ...

switch event.type {
case .CommitCommentEvent(let payload):
    print(payload.comment)

case .ReferencePayload(let payload):
    print(payload.referenceName)
}
```
